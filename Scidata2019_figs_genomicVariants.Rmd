---
title: "SciDataRelease_Figures"
author: Jineta Banerjee
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: 
  html_document:
    toc: true
    number_sections: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    fig_width: 7
    fig_height: 6
    fig_caption: true
    df_print: paged 
    #code_folding: true 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r lib_synapser, echo=FALSE, eval=TRUE, results='hide', message=FALSE, warning=FALSE, include=FALSE}

library(synapser)
library(synapserutils)

library(BiocManager)
library(gProfileR)
library(tidyverse)
library(DT)
library(maftools)
library(GenVisR)
library(RColorBrewer)
library(wesanderson)

## The login credentials have been stored in .synapseConfig file in the home dir. If you dont have this setup, please make the file before trying to login.
synLogin()

```

### Summary :

The code below makes figures for the Scientific Data Paper showcasing the JHU Biobank data.

```{r extracting annotations for each study, echo=FALSE, eval=TRUE, results='hide', message=FALSE, warning=FALSE}

#Extract the annotation file from Synapse:
jhu_files <- synTableQuery("SELECT * FROM syn13363852 WHERE assay = 'exomeSeq' AND fileFormat = 'vcf' AND name LIKE '%.vcf.gz' AND sciDataRelease = 'true' ")$asDataFrame()
jhu_anno_select <- jhu_files

#Add tumor barcode column to annotations to match MAF file tumor code
jhu_anno_select$Tumor_Sample_Barcode <- gsub("[[:alpha:]_\\.*]", "", jhu_anno_select$name) 

# Select specific columns for ease of use
jhu_anno_new <- subset(jhu_anno_select, select=c("id", "name", "age", "assay", "diagnosis", "individualID", "nf1Genotype",
                                                 "tissue", "nf2Genotype", "isCellLine","transplantationType", "sex", "species", 
                                                 "specimenID", "study", "studyId", "tumorType", "Tumor_Sample_Barcode"))


#Add tumor annotation to replace NA
jhu_anno_new$tumorType[(jhu_anno_new$tissue == "Buffy Coat")] <- "Normal"
jhu_anno_new$tumorType[str_detect(jhu_anno_new$specimenID, "Blood")] <- "Normal"
jhu_anno_new$tumorType[(jhu_anno_new$tissue == "Skin")] <- "Normal"
jhu_anno_new$tumorType[str_detect(jhu_anno_new$specimenID, "Neurofibroma")] <- "Neurofibroma"

#Add MAF filepath column to annotation file ( this assumes that you have downloaded the relevant original maf files from https://www.synapse.org/#!Synapse:syn19046889 )
jhu_anno_new <- 
  jhu_anno_new %>%
  mutate(filepath = paste("/home/jbanerjee/maf_data/", Tumor_Sample_Barcode, ".vep.maf")) %>%
  as.data.frame()

#remove unwanted space in filepath
jhu_anno_new$filepath <- gsub(" ", "", jhu_anno_new$filepath) 

#select all rows that have assigned individual ids (get rid of any row that is not a bonafide sample)
jhu_anno_new <- jhu_anno_new[(is.na(jhu_anno_new$individualID) == FALSE), ]


##### NOTE #####
# If a sample is normal but has a separate VCF file generated by callers other than VARSCAN, then using its barcode as Tumor_Sample_Barcode will lead to the following :
# -Tumor_Sample_Barcode field has the barcode of the normal sample, matched_norm_sample Alleles are replaced by reference allele, Matched Normal Sample barcode says "NORMAL". Other than these nothing changes.
# If a sample is normal, using its barcode as Matched_normal_sample_barcode will lead to the following:
# - Matched_norm_sample_barcode has the sample barcode, Tumor_sample_barcode says "TUMOR" . This leads to maftools not recognising the right sample maf to merge/annotate
# - The + strand of Tumor_sample_allele is replaced by ref allele, but -strand has - strand allele of sample, matched norm sample alleles are the same as tumor sample alleles if the file were generated with barcode in Tumor_sample_barcode field
# All other fields stay exactly same for both cases. So from now on.. for consistency we will use all samples with their barcode in Tumor_sample_barcode field. The annotations associated with the samples will determine whether a sample was normal or tumor.

```
&nbsp;

### Figure.1 

Make a plot of all the NF1 pathogenic variants from the mafs that we are releasing for the sciData paper (sciDataRelease = TRUE)? This will serve as technical validation for the paper. So something that shows the variants (some samples might not have one?), and whether or not the sample is a pdx, cell line, blood, or tumor.

```{r all_sample_oncoplot, echo= FALSE, eval=TRUE, fig.height=8,fig.width=15, results='show', message=FALSE, warning=FALSE}

#Add sampleType annotation column for the figure
jhu_anno_new$sampleType <- "Tissue"
jhu_anno_new$sampleType[jhu_anno_new$isCellLine==TRUE] <- "Cell Line"
jhu_anno_new$sampleType[jhu_anno_new$transplantationType=="xenograft"] <- "Xenograft"

###### Make color scheme for plots ########

## Make colors for plots
fabcolors = RColorBrewer::brewer.pal(n = 11,name = 'RdGy')
col = RColorBrewer::brewer.pal(n = 10,name = 'PRGn')
allcolors <- c(fabcolors, col)
sampleID <- sort(unique(as.character(unique(jhu_anno_new$individualID))))
names(allcolors) = c(sampleID)
allcolors <- list(allcolors)

morecolors1 <- wes_palette("Darjeeling1", n=4, type = "discrete")
#morecolors1 = RColorBrewer::brewer.pal(n = 4,name = 'BrBG')
tumortypes <- sort(unique(as.character(unique(jhu_anno_new$tumorType))))
names(morecolors1) <- c(tumortypes)
morecolors1 <- list(morecolors1)

morecolors2 <- wes_palette("Moonrise2", n=3, type = "discrete")
#morecolors2 = RColorBrewer::brewer.pal(n = 3,name = 'Accent')
sampletype <- sort(unique(as.character(unique(jhu_anno_new$sampleType))))
names(morecolors2) = c(sampletype)
morecolors2 <- list(morecolors2)

color_list <- c(allcolors, morecolors1, morecolors2)


####### Plots  ###########

## Oncoplot showing all the samples and all genes that are important for cNF and MPNST

# Make "maf object" to work with maftools for easy visualization 
jhu_maf <- merge_mafs(c(jhu_anno_new$filepath), verbose = TRUE, clinicalData = jhu_anno_new) 

# Make oncoplot for all samples for specific genes (top column bar shows mutational burden of the samples, row bar on the right shows frequency of mutations per gene)
png("Scidata_fig_1_allsamples_oncoplot.png",height = 800, width = 1800 )
oncoplot(jhu_maf, genes = c("NF1","PIK3CA", "SUZ12", "EGFR", "ASTE1", "MEK1", "MEK2", "LRP1B", "MSH3", "PDCD1", "S1PR2", "EED", "EZH2"),
         drawRowBar = TRUE, drawColBar = TRUE, logColBar = FALSE,
         clinicalFeatures = c("individualID", "tumorType", "sampleType"),
         sortByAnnotation = TRUE, annotationColor = color_list, groupAnnotationBySize = FALSE, 
         keepGeneOrder = TRUE, GeneOrderSort = TRUE, removeNonMutated = FALSE, 
         SampleNamefont = 5,annotationFontSize = 1.8, fontSize = 1.0,legendFontSize = 1.8,
         titleFontSize = 1.5, bgCol = "white", borderCol = "white")
dev.off()

```

## Figure 2

Plot to show that cell line mutations match the sample. It'd be nice to see the NF1 and Pik3ca mutations for the 2-031 samples as a proof of cell line data. Our oncoplot for sample 2-031 does not capture any SNPs in NF1, possibly due to copy number variation in NF1 which is not reflected in VCFs. We are proceeding with CNV analysis for 2-031 for confirmation. 

We were able to crosscheck other samples in the bank with their clinical sequencing data (provided by Dr. Pratilas in https://app.box.com/file/530606854188), all the splice variants were confirmed but any large deletions were not captured in the VCF/MAF data files. This further confirms the need for CNV analysis for samples with these kind of deletions.

```{r sample 2-031, echo= FALSE, eval=TRUE, fig.height=8,fig.width=8, results='show', message=FALSE, warning=FALSE}

#Select specific sample files (select only the normal tissue and MPNST tissue and cell line samples)
sample_2031 <- subset(jhu_anno_new, assay == "exomeSeq" & individualID == "2-031" & specimenID != "2-031 Xenograft")


#Make Maf file for sample 2-031
jhu_sample_2031 <- merge_mafs(c(sample_2031$filepath), verbose = TRUE, clinicalData = sample_2031) 

# Make oncoplot to show the SNPs and mutation of the samples in various genes of interest
print("Fig 1 : Sample 2-031")
png("Sample_2-031.png", width=800, height = 800)
oncoplot(jhu_sample_2031, genes = c("NF1","PIK3CA", "PRC2","MEK1", "MEK2", "SUZ12", "ASTE1", "EGFR", "LRP1B", "MSH3", "PDCD1", "S1PR2", "EED", "EZH2"),
         drawRowBar = TRUE, drawColBar = TRUE,logColBar = FALSE,
         clinicalFeatures = c("tumorType", "sampleType","individualID"),
         sortByAnnotation = TRUE, annotationColor = color_list, groupAnnotationBySize = FALSE,
         keepGeneOrder = TRUE, GeneOrderSort = TRUE, removeNonMutated = FALSE, 
         SampleNamefont = 5,annotationFontSize = 1.5, fontSize = 1,legendFontSize = 1.8,
         titleFontSize = 1.0, bgCol = "white", borderCol = "white")
dev.off()

```
